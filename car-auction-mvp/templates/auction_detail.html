{% extends "base.html" %}

{% block title %}{{ auction.car.year }} {{ auction.car.make }} {{ auction.car.model }}{% endblock %}

{% block content %}
    {% if current_user.is_authenticated and current_user.is_admin and not auction.car.is_approved %}
    <div class="admin-actions" style="background-color: #fffbe6; border: 1px solid #ffe58f; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
        <h3 style="margin-top: 0;">Admin Actions</h3>
        <p>This car is pending approval. Review the details below and take an action.</p>
        <div style="display: flex; gap: 10px; align-items: center;">
            <form action="{{ url_for('admin.approve_car', car_id=auction.car.id) }}" method="post" style="display:inline;">
                <button type="submit" style="background-color: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer;">Approve</button>
            </form>
            <a href="{{ url_for('admin.edit_auction', auction_id=auction.id) }}" style="text-decoration: none; background-color: #007bff; color: white; padding: 8px 12px; border-radius: 3px;">Edit</a>
            <form action="{{ url_for('admin.delete_auction', auction_id=auction.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this submission? This cannot be undone.');">
                <button type="submit" style="background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer;">Delete</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="detail-page-container">
        <div class="main-content">
            <h1>{{ auction.car.year }} {{ auction.car.make }} {{ auction.car.model }}</h1>
            <div class="image-gallery">
                <div class="main-image">
                    <img id="main-car-image" src="{{ auction.car.primary_image_url or url_for('static', filename='img/default_car.png') }}" alt="Car Image" style="max-width: 100%; border-radius: 8px;">
                </div>
                {% if auction.car.images|length > 1 %}
                <div class="thumbnails" style="display: flex; gap: 10px; margin-top: 10px;">
                    {% for image in auction.car.images %}
                    <img src="{{ image.image_url }}" class="thumbnail-img" alt="Thumbnail" style="width: 100px; height: 75px; object-fit: cover; cursor: pointer; border-radius: 4px;">
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <h2>Auction Details</h2>
            <p>{{ auction.car.description }}</p>
            <p><strong>Auction ends:</strong> {{ auction.end_time.strftime('%Y-%m-%d %H:%M') }} UTC</p>
            <p><strong>Starting Price:</strong> {{ '{:,.2f}'.format(auction.start_price) }} ETB</p>
            <hr>
            <h3>Current Price: {{ '{:,.2f}'.format(auction.current_price) }} ETB</h3>
            {% if highest_bid %}
                <p>Highest bid by: {{ highest_bid.bidder.username }}</p>
            {% else %}
                <p>No bids yet. Be the first!</p>
            {% endif %}

            <hr>
            
            {% if current_user.is_authenticated %}
                <form method="POST" action="{{ url_for('auctions.auction_detail', auction_id=auction.id) }}" style="margin-bottom: 20px;">
                    {{ bid_form.hidden_tag() }}
                    <p>
                        {{ bid_form.amount.label }}<br>
                        {{ bid_form.amount(size=20) }}
                        {% for error in bid_form.amount.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                        {% endfor %}
                    </p>
                    <p>{{ bid_form.submit() }}</p>
                </form>
            {% else %}
                <p><a href="{{ url_for('auth.login', next=request.path) }}">Log in to place a bid.</a></p>
            {% endif %}

            <hr>

            <div class="info-columns" style="display: flex; gap: 30px;">
                <div class="bid-history-column" style="flex: 1;">
                    <h3>Bid History</h3>
                    {% if all_bids %}
                        <table border="1" style="width:100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background-color: #f2f2f2;">
                                    <th style="padding: 8px; text-align: left;">Bidder</th>
                                    <th style="padding: 8px; text-align: left;">Amount (ETB)</th>
                                    <th style="padding: 8px; text-align: left;">Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bid in all_bids %}
                                <tr>
                                    <td style="padding: 8px;">{{ bid.bidder.username }}</td>
                                    <td style="padding: 8px;">{{ '{:,.2f}'.format(bid.amount) }}</td>
                                    <td style="padding: 8px;">{{ bid.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} UTC</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>No bid history available.</p>
                    {% endif %}
                </div>

                <div class="qna-column" style="flex: 1;">
                    <h3>Questions & Answers</h3>
                    <div class="qna-section">
                        {% for q in questions %}
                            {% include '_question_item.html' %}
                        {% else %}
                            <p id="no-questions-message">No questions have been asked yet. Be the first!</p>
                        {% endfor %}
                    </div>

                    {% if current_user.is_authenticated and current_user.id != auction.car.owner_id %}
                        <div class="ask-question-container" style="margin-top: 20px;">
                            <button id="ask-question-btn">Ask the Seller a Question</button>
                            <div id="ask-question-form-div" style="display: none; margin-top: 10px;">
                                <form id="question-form" method="POST" action="{{ url_for('auctions.auction_detail', auction_id=auction.id) }}">
                                    {{ question_form.hidden_tag() }}
                                    <p>
                                        {{ question_form.question_text.label }}<br>
                                        {{ question_form.question_text(rows=4, style="width: 100%;") }}<br>
                                        <span id="question-error" style="color: red;"></span>
                                    </p>
                                    <p>
                                        {{ question_form.submit_question() }}
                                        <span id="question-success" style="color: green; margin-left: 10px;"></span>
                                    </p>
                                </form>
                            </div>
                        </div>
                    {% elif not current_user.is_authenticated %}
                        <p><a href="{{ url_for('auth.login', next=request.path) }}">Log in to ask a question.</a></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>{{ similarity_reason or 'Similar Listings' }}</h3>
            {% if similar_auctions %}
                {% for sim_auction in similar_auctions %}
                    <div class="auction-card" style="margin-bottom: 15px;">
                        <img src="{{ sim_auction.car.primary_image_url or url_for('static', filename='img/default_car.png') }}" alt="Car Image">
                        <h4 style="margin: 5px 0;">{{ sim_auction.car.year }} {{ sim_auction.car.make }} {{ sim_auction.car.model }}</h4>
                        <p style="margin: 5px 0;">{{ '{:,.2f}'.format(sim_auction.current_price) }} ETB</p>
                        <a href="{{ url_for('auctions.auction_detail', auction_id=sim_auction.id) }}">View</a>
                    </div>
                {% endfor %}
            {% else %}
                <p>No other similar cars found.</p>
            {% endif %}
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image gallery logic
    const mainImage = document.getElementById('main-car-image');
    const thumbnails = document.querySelectorAll('.thumbnail-img');

    thumbnails.forEach(thumb => {
        thumb.addEventListener('click', function() {
            mainImage.src = this.src;
        });
    });


    // Q&A Logic
    const askBtn = document.getElementById('ask-question-btn');
    const formDiv = document.getElementById('ask-question-form-div');
    const questionForm = document.getElementById('question-form');

    if (askBtn) {
        askBtn.addEventListener('click', function() {
            formDiv.style.display = 'block';
            this.style.display = 'none';
        });
    }

    // Add a click listener to the whole document to hide the form when clicking away
    document.addEventListener('click', function(event) {
        // Check if the form is visible and if the click was outside the form container and not on the button that opens it
        if (formDiv && formDiv.style.display === 'block' && !formDiv.contains(event.target) && event.target !== askBtn) {
            formDiv.style.display = 'none';
            askBtn.style.display = 'block';
        }
    });


    if (questionForm) {
        questionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const successMsg = document.getElementById('question-success');
            const errorMsg = document.getElementById('question-error');

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const qnaSection = document.querySelector('.qna-section');
                    const noQuestionsMsg = document.getElementById('no-questions-message');
                    if (noQuestionsMsg) {
                        noQuestionsMsg.remove();
                    }
                    qnaSection.insertAdjacentHTML('beforeend', data.question_html);
                    questionForm.reset();
                    errorMsg.textContent = '';
                    successMsg.textContent = data.message;
                    setTimeout(() => { successMsg.textContent = ''; }, 3000);
                } else {
                    errorMsg.textContent = data.error || 'An unknown error occurred.';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
});
</script>
{% endblock %}
