{% extends "base.html" %}

{% block title %}{{ auction.car.year }} {{ auction.car.make }} {{ auction.car.model }}{% endblock %}

{% block content %}
    {% if current_user.is_authenticated and current_user.is_admin and not auction.car.is_approved %}
    <div class="admin-actions pending">
        <h3>Admin Actions</h3>
        <p>This car is pending approval. Review the details below and take an action.</p>
        <div class="button-group">
            <form action="{{ url_for('admin.approve_car', car_id=auction.car.id) }}" method="post">
                <button type="submit" class="approve">Approve</button>
            </form>
            <a href="{{ url_for('admin.edit_auction', auction_id=auction.id) }}" class="edit">Edit</a>
            <form action="{{ url_for('admin.delete_auction', auction_id=auction.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this submission? This cannot be undone.');">
                <button type="submit" class="delete">Delete</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="detail-page-container">
        <div class="main-content">
            <div class="title-with-tag">
                <h1>{{ auction.car.year }} {{ auction.car.make }} {{ auction.car.model }}</h1>
                {% if auction.car.owner.is_admin %}
                    <span class="role-badge admin large">Admin Listing</span>
                {% elif auction.car.owner.is_dealer %}
                    <span class="role-badge dealer large">Dealer Listing</span>
                {% elif auction.car.owner.is_rental_company %}
                    <span class="role-badge rental large">Rental Listing</span>
                {% endif %}
            </div>
            <div class="image-gallery">
                <div class="main-image-container">
                    <img id="main-car-image" src="{{ auction.car.primary_image_url or url_for('static', filename='img/default_car.png') }}" alt="Car Image">
                    {% if auction.car.images|length > 1 %}
                        <button id="prev-image-btn" class="gallery-nav prev">&lt;</button>
                        <button id="next-image-btn" class="gallery-nav next">&gt;</button>
                    {% endif %}
                </div>
                {% if auction.car.images|length > 1 %}
                <div class="thumbnails">
                    {% for image in auction.car.images %}
                    <img src="{{ image.image_url }}" class="thumbnail-img" alt="Thumbnail">
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <h2>Auction Details</h2>
            <p>{{ auction.car.description }}</p>
            <p><strong>Auction ends:</strong> {{ auction.end_time.strftime('%Y-%m-%d %H:%M') }} UTC</p>
            <p><strong>Starting Price:</strong> {{ '{:,.2f}'.format(auction.start_price) }} ETB</p>
            <hr>
            <h3>Current Price: {{ '{:,.2f}'.format(auction.current_price) }} ETB</h3>
            {% if highest_bid %}
                <p>Highest bid by: {{ highest_bid.bidder.username }}</p>
            {% else %}
                <p>No bids yet. Be the first!</p>
            {% endif %}

            <hr>
            
            {% if current_user.is_authenticated %}
                <form method="POST" action="{{ url_for('auctions.auction_detail', auction_id=auction.id) }}">
                    {{ bid_form.hidden_tag() }}
                    <p>
                        {{ bid_form.amount.label }}<br>
                        {{ bid_form.amount(size=20) }}
                        {% for error in bid_form.amount.errors %}
                        <div class="form-error">{{ error }}</div>
                        {% endfor %}
                    </p>
                    <p>{{ bid_form.submit(class='btn approve') }}</p>
                </form>
            {% else %}
                <p><a href="{{ url_for('auth.login', next=request.path) }}">Log in to place a bid.</a></p>
            {% endif %}

            <hr>

            <div class="info-columns">
                <div class="bid-history-column">
                    <h3>Bid History</h3>
                    {% if all_bids %}
                        <table>
                            <thead>
                                <tr>
                                    <th>Bidder</th>
                                    <th>Amount (ETB)</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bid in all_bids %}
                                <tr>
                                    <td>{{ bid.bidder.username }}</td>
                                    <td>{{ '{:,.2f}'.format(bid.amount) }}</td>
                                    <td>{{ bid.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>No bid history available.</p>
                    {% endif %}
                </div>

                <div class="qna-column">
                    <h3>Questions & Answers</h3>
                    <div class="qna-section">
                        {% for q in questions %}
                            {% include '_question_item.html' %}
                        {% else %}
                            <p id="no-questions-message">No questions have been asked yet. Be the first!</p>
                        {% endfor %}
                    </div>

                    {% if current_user.is_authenticated and current_user.id != auction.car.owner_id %}
                        <div class="ask-question-container">
                            <button id="ask-question-btn" class="btn edit">Ask the Seller a Question</button>
                            <div id="ask-question-form-div">
                                <form id="question-form" method="POST" action="{{ url_for('auctions.auction_detail', auction_id=auction.id) }}">
                                    {{ question_form.hidden_tag() }}
                                    <p>
                                        {{ question_form.question_text.label }}<br>
                                        {{ question_form.question_text(rows=4) }}<br>
                                        <span id="question-error"></span>
                                    </p>
                                    <p>
                                        {{ question_form.submit_question(class='btn approve') }}
                                        <span id="question-success"></span>
                                    </p>
                                </form>
                            </div>
                        </div>
                    {% elif not current_user.is_authenticated %}
                        <p><a href="{{ url_for('auth.login', next=request.path) }}">Log in to ask a question.</a></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>{{ similarity_reason or 'Similar Listings' }}</h3>
            {% if similar_auctions %}
                {% for sim_auction in similar_auctions %}
                    <a href="{{ url_for('auctions.auction_detail', auction_id=sim_auction.id) }}" class="auction-card-link">
                        <div class="auction-card">
                            {% if sim_auction.car.owner.is_admin %}
                                <span class="role-badge admin">Admin</span>
                            {% elif sim_auction.car.owner.is_dealer %}
                                <span class="role-badge dealer">Dealer</span>
                            {% elif sim_auction.car.owner.is_rental_company %}
                                <span class="role-badge rental">Rental</span>
                            {% endif %}
                            <img src="{{ sim_auction.car.primary_image_url or url_for('static', filename='img/default_car.png') }}" alt="Car Image">
                            <div class="card-content">
                                <h4>{{ sim_auction.car.year }} {{ sim_auction.car.make }} {{ sim_auction.car.model }}</h4>
                                <p>{{ '{:,.2f}'.format(sim_auction.current_price) }} ETB</p>
                            </div>
                        </div>
                    </a>
                {% endfor %}
            {% else %}
                <p>No other similar cars found.</p>
            {% endif %}
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image gallery logic
    const imageGallery = document.querySelector('.image-gallery');
    if (imageGallery) {
        const mainImage = document.getElementById('main-car-image');
        const thumbnails = document.querySelectorAll('.thumbnail-img');
        const prevBtn = document.getElementById('prev-image-btn');
        const nextBtn = document.getElementById('next-image-btn');

        let imageUrls = Array.from(thumbnails).map(thumb => thumb.src);
        let currentIndex = 0;

        function updateMainImage(index) {
            mainImage.src = imageUrls[index];
            currentIndex = index;
            // Highlight the active thumbnail
            thumbnails.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }

        thumbnails.forEach((thumb, index) => {
            thumb.addEventListener('click', function() {
                updateMainImage(index);
            });
        });

        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                let newIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
                updateMainImage(newIndex);
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                let newIndex = (currentIndex + 1) % imageUrls.length;
                updateMainImage(newIndex);
            });
        }

        // Set initial active thumbnail
        if (thumbnails.length > 0) {
            thumbnails[0].classList.add('active');
        }
    }

    // Q&A Logic
    const askBtn = document.getElementById('ask-question-btn');
    const formDiv = document.getElementById('ask-question-form-div');
    const questionForm = document.getElementById('question-form');

    if (askBtn) {
        askBtn.addEventListener('click', function() {
            formDiv.style.display = 'block';
            this.style.display = 'none';
        });
    }

    // Add a click listener to the whole document to hide the form when clicking away
    document.addEventListener('click', function(event) {
        // Check if the form is visible and if the click was outside the form container and not on the button that opens it
        if (formDiv && formDiv.style.display === 'block' && !formDiv.contains(event.target) && event.target !== askBtn) {
            formDiv.style.display = 'none';
            askBtn.style.display = 'block';
        }
    });


    if (questionForm) {
        questionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const successMsg = document.getElementById('question-success');
            const errorMsg = document.getElementById('question-error');

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const qnaSection = document.querySelector('.qna-section');
                    const noQuestionsMsg = document.getElementById('no-questions-message');
                    if (noQuestionsMsg) {
                        noQuestionsMsg.remove();
                    }
                    qnaSection.insertAdjacentHTML('beforeend', data.question_html);
                    questionForm.reset();
                    errorMsg.textContent = '';
                    successMsg.textContent = data.message;
                    setTimeout(() => { successMsg.textContent = ''; }, 3000);
                } else {
                    errorMsg.textContent = data.error || 'An unknown error occurred.';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
});
</script>
{% endblock %}
