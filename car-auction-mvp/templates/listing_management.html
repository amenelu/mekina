{% extends "base.html" %}

{% block title %}Listing Management{% endblock %}

{% block content %}
    <h1>Listing Management</h1>

    <table>
        <thead>
            <tr>
                <th>Car</th>
                <th>Owner</th>
                <th>Listing Type</th>
                <th>Visibility</th>
                <th>Price / Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for car in cars.items %}
            {% set detail_url = '#' %}
            {% if car.listing_type == 'auction' and car.auction %}
                {% set detail_url = url_for('auctions.auction_detail', auction_id=car.auction.id) %}
            {% elif car.listing_type == 'sale' %}
                {% set detail_url = url_for('main.car_detail', car_id=car.id) %}
            {% elif car.listing_type == 'rental' and car.rental_listing %}
                {% set detail_url = url_for('rentals.rental_detail', listing_id=car.rental_listing.id) %}
            {% endif %}
            <tr data-href="{{ detail_url }}" style="cursor: pointer;">
                <td>{{ car.year }} {{ car.make }} {{ car.model }}</td>
                <td>
                    <strong>{{ car.owner.username }}</strong><br>
                    <small>{{ car.owner.email }}</small><br>
                    <small>{{ car.owner.phone_number or 'No phone' }}</small>
                </td>
                <td>
                    <span class="listing-type-tag small {{ car.listing_type.lower() }}">{{ car.listing_type|title }}</span>
                </td>
                <td>
                    <label class="switch">
                        <input type="checkbox" class="visibility-toggle" data-car-id="{{ car.id }}" {% if car.is_active %}checked{% endif %}>
                        <span class="slider round"></span>
                    </label>
                    <span id="status-text-{{ car.id }}" class="availability-text">{% if car.is_active %}Active{% else %}Inactive{% endif %}</span>
                </td>
                <td>
                    {% if car.listing_type == 'auction' and car.auction %}
                        {{ '{:,.2f}'.format(car.auction.current_price) }} ETB
                        <br>
                        <small>
                        {% if car.auction.end_time > now %}
                            Ends: {{ car.auction.end_time.strftime('%b %d, %H:%M') }}
                        {% else %}
                            Ended
                        {% endif %}
                        </small>
                    {% elif car.listing_type == 'sale' %}
                        {{ '{:,.2f}'.format(car.fixed_price) }} ETB
                    {% elif car.listing_type == 'rental' and car.rental_listing %}
                        {{ '{:,.2f}'.format(car.rental_listing.price_per_day) }} ETB/day
                    {% endif %}
                </td>
                <td class="button-group">
                    <a href="{{ url_for('admin.edit_listing', car_id=car.id) }}" class="btn edit">Edit</a>
                    <form action="{{ url_for('admin.delete_listing', car_id=car.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this listing? This cannot be undone.');">
                        <button type="submit" class="btn delete">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination">
        {% if cars.has_prev %}<a href="{{ url_for('auctions.list_auctions', page=cars.prev_num) }}">&laquo; Previous</a>{% endif %}
        <span>Page {{ cars.page }} of {{ cars.pages }}</span>
        {% if cars.has_next %}<a href="{{ url_for('auctions.list_auctions', page=cars.next_num) }}">Next &raquo;</a>{% endif %}
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Make table rows clickable
    document.querySelectorAll('tr[data-href]').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if a button or link inside the row was clicked
            if (e.target.closest('a, button, .switch')) return;
            window.location.href = this.dataset.href;
        });
    });

    // Handle the visibility toggle
    document.querySelectorAll('.visibility-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const carId = this.dataset.carId;
            const statusText = document.getElementById(`status-text-${carId}`);

            fetch(`/seller/toggle_active/${carId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusText.textContent = data.status_text;
                    // Optionally, you can show a flash message dynamically, but a page reload on next navigation will show it.
                } else {
                    this.checked = !this.checked; // Revert toggle on error
                    alert(data.message || 'An error occurred.');
                }
            });
        });
    });
});
</script>
{% endblock %}
