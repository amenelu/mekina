{% extends "base.html" %}

{% block title %}Listing Management{% endblock %}

{% block body_class %}listing-management-page{% endblock %}

{% block main_content %}
<div class="dashboard-full-width-container">
    <div class="dashboard-header-wrapper">
        <div class="container">
            <div class="dashboard-header">
                <div class="header-main">
                    <h1>All Listings Management</h1>
                    <p>Review, edit, and manage all car listings on the platform.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-section">
            {% if cars.items %}
                <div class="table-responsive-wrapper">
                    <table class="dashboard-table">
                        <thead>
                            <tr>
                                <th>Car</th>
                                <th>Owner</th>
                                <th>Listing Type</th>
                                <th>Visibility</th>
                                <th>Price / Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for car in cars.items %}
                            <tr>
                                <td data-label="Car">{{ car.year }} {{ car.make }} {{ car.model }}</td>
                                <td data-label="Owner">{{ car.owner.username }}</td>
                                <td data-label="Listing Type"><span class="listing-type-tag {{ car.listing_type.lower() }}">{{ car.listing_type|title }}</span></td>
                                <td data-label="Visibility">
                                    <label class="switch">
                                        <input type="checkbox" class="visibility-toggle" data-car-id="{{ car.id }}" {% if car.is_active %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                    <span id="status-text-{{ car.id }}" class="availability-text">{% if car.is_active %}Active{% else %}Inactive{% endif %}</span>
                                </td>
                                <td data-label="Price / Status">
                                    {% if car.listing_type == 'auction' and car.auction %}
                                        {{ '{:,.2f}'.format(car.auction.current_price) }} ETB
                                        <br><small>{% if car.auction.end_time > now %}Ends: {{ car.auction.end_time.strftime('%b %d, %H:%M') }}{% else %}Ended{% endif %}</small>
                                    {% elif car.listing_type == 'sale' %}
                                        {{ '{:,.2f}'.format(car.fixed_price) }} ETB
                                    {% elif car.listing_type == 'rental' and car.rental_listing %}
                                        {{ '{:,.2f}'.format(car.rental_listing.price_per_day) }} ETB/day
                                    {% endif %}
                                </td>
                                <td data-label="Actions">
                                    <div class="button-group">
                                        <a href="{{ url_for('admin.edit_listing', car_id=car.id) }}" class="btn edit small">Edit</a>
                                        <form action="{{ url_for('admin.delete_listing', car_id=car.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this listing? This cannot be undone.');">
                                            <button type="submit" class="btn delete small">Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    {% if cars.has_prev %}<a href="{{ url_for('auctions.list_auctions', page=cars.prev_num) }}" class="btn">&laquo; Previous</a>{% endif %}
                    <span>Page {{ cars.page }} of {{ cars.pages }}</span>
                    {% if cars.has_next %}<a href="{{ url_for('auctions.list_auctions', page=cars.next_num) }}" class="btn">Next &raquo;</a>{% endif %}
                </div>
            {% else %}
                <p>There are no listings on the platform yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
