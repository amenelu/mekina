{% extends "base.html" %}

{% block title %}Compare Vehicles{% endblock %}

{% block content %}
<div class="comparison-wrapper">
    <h1 class="mb-4">Compare Vehicles</h1>

    {# Define the comparison attributes in one place for easy maintenance #}
    {% set features = [
        {'label': 'Price', 'attr': 'display_price', 'best_value_key': 'price', 'format': 'price'},
        {'label': 'Mileage', 'attr': 'mileage', 'best_value_key': 'mileage', 'format': 'km'},
        {'label': 'Year', 'attr': 'year', 'best_value_key': 'year'},
        {'label': 'Condition', 'attr': 'condition'},
        {'label': 'Body Type', 'attr': 'body_type'},
        {'label': 'Transmission', 'attr': 'transmission'},
        {'label': 'Fuel Type', 'attr': 'fuel_type'},
        {'label': 'Engine Size', 'attr': 'engine_size'}
    ] %}


    {% if cars %}
        <div class="table-responsive-wrapper desktop-only">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Feature</th>
                        {% for car in cars %}
                        <th>
                            <a href="{{ url_for('main.car_detail', car_id=car.id) if car.listing_type == 'sale' else url_for('auctions.auction_detail', auction_id=car.auction.id) if car.auction else '#' }}">
                                <img src="{{ car.primary_image_url or url_for('static', filename='img/default_car.png') }}" alt="{{ car.make }} {{ car.model }}" class="comparison-image">
                                <div class="comparison-car-title">{{ car.year }} {{ car.make }} {{ car.model }}</div>
                            </a>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for feature in features %}
                        <tr>
                            <td>{{ feature.label }}</td>
                            {% for car in cars %}
                                {% set value = car[feature.attr] %}
                                <td class="{{ 'best-value' if feature.best_value_key and car.id in best_values[feature.best_value_key].ids }}">
                                    {% if feature.format == 'price' %}{{ '{:,.0f}'.format(value) if value < 9999999999 else 'N/A' }} ETB
                                    {% elif feature.format == 'km' %}{{ '{:,}'.format(value) if value is not none else 'N/A' }} km
                                    {% else %}{{ value or 'N/A' }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mobile-comparison-cards mobile-only">
            {% for car in cars %}
            <div class="comparison-card">
                <a href="{{ url_for('main.car_detail', car_id=car.id) if car.listing_type == 'sale' else url_for('auctions.auction_detail', auction_id=car.auction.id) if car.auction else '#' }}" class="card-header">
                    <img src="{{ car.primary_image_url or url_for('static', filename='img/default_car.png') }}" alt="{{ car.make }} {{ car.model }}" class="comparison-image">
                    <div class="comparison-car-title">{{ car.year }} {{ car.make }} {{ car.model }}</div>
                </a>
                <div class="card-body">
                    {% for feature in features %}
                        {% set value = car[feature.attr] %}
                        <div class="spec-row {{ 'best-value' if feature.best_value_key and car.id in best_values[feature.best_value_key].ids }}">
                            <span class="spec-label">{{ feature.label }}</span>
                            <span class="spec-value">
                                {% if feature.format == 'price' %}{{ '{:,.0f}'.format(value) if value < 9999999999 else 'N/A' }} ETB
                                {% elif feature.format == 'km' %}{{ '{:,}'.format(value) if value is not none else 'N/A' }} km
                                {% else %}{{ value or 'N/A' }}
                                {% endif %}
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

    {% else %}
        <div class="no-comparison-items">
            <h2>No cars selected for comparison.</h2>
            <p>Go to the listings page to select some cars to compare.</p>
            <a href="{{ url_for('main.all_listings') }}" class="btn approve">View All Listings</a>
        </div>
    {% endif %}
</div>
{% endblock %}