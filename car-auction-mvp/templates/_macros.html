{# /home/amen/mekina/car-auction-mvp/templates/_macros.html #}
{% macro offer_card(bid, car_request, question_form, is_lowest=false) %}
<div class="offer-card {% if is_lowest %}lowest-bid-highlight{% endif %}">
    <div class="offer-header">
        <div class="offer-price-options">
            <div class="offer-price cash">
                <span>Cash Price</span>
                {{ '{:,.2f}'.format(bid.price) }} ETB
            </div>
            {% if bid.price_with_loan %}
            <div class="offer-price loan">
                <span>With Loan</span>
                {{ '{:,.2f}'.format(bid.price_with_loan) }} ETB
            </div>
            {% endif %}
        </div>
        <div class="offer-meta">
            <span>From: <strong><a href="{{ url_for('dealer.profile', dealer_id=bid.dealer.id) }}">{{ bid.dealer.username }}</a></strong></span>
            <span>Received: {{ bid.timestamp.strftime('%b %d, %Y') }}</span>
        </div>
    </div>
    {% if bid.image_url %}
    <div class="offer-photo" style="margin: 1rem 0; text-align: center;">
        <img src="{{ bid.image_url }}" alt="Car offered by {{ bid.dealer.username }}" style="max-width: 100%; height: auto; border-radius: var(--radius);">
    </div>
    {% endif %}
    <div class="offer-details-grid">
        <div><strong>Car:</strong> {{ bid.make }} {{ bid.model }}</div>
        <div><strong>Year:</strong> {{ bid.car_year }}</div>
        <div><strong>Condition:</strong> {{ bid.condition }}</div>
        <div><strong>Mileage:</strong> {{ '{:,}'.format(bid.mileage) }} km</div>
        <div><strong>Availability:</strong> {{ bid.availability }}</div>
    </div>
    {% if bid.extras %}
    <div class="offer-extras">
        <strong>Extras:</strong> {{ bid.extras }}
    </div>
    {% endif %}
    {% if bid.message %}
    <div class="offer-message">
        <strong>Message from Dealer:</strong>
        <blockquote>{{ bid.message }}</blockquote>
    </div>
    {% endif %}

    {# --- Q&A Section for this Bid --- #}
    <div class="offer-qna-section" id="qna-for-bid-{{ bid.id }}">
        <h5>Questions about this offer</h5>
        {% if bid.questions.all() %}
            {% for q in bid.questions %}
            <div class="qna-item">
                <p class="question"><strong>Q:</strong> {{ q.question_text }} <span class="meta"> (from you, {{ q.timestamp.strftime('%b %d') }})</span></p>
                {% if q.answer_text %}
                <p class="answer"><strong>A:</strong> {{ q.answer_text }} <span class="meta">(from dealer, {{ q.answer_timestamp.strftime('%b %d') }})</span></p>
                {% else %}
                <p class="answer-pending"><em>Awaiting dealer response...</em></p>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p class="no-questions-yet">No questions asked about this offer yet.</p>
        {% endif %}

        {# --- Ask Question Form --- #}
        {% if car_request.status == 'active' %}
        <div class="ask-question-container">
            <button class="btn-link ask-question-btn" data-bid-id="{{ bid.id }}">Ask the dealer a question</button>
            <div class="ask-question-form" id="ask-form-{{ bid.id }}" style="display: none;">
                <form method="POST" action="{{ url_for('request.ask_dealer_question', bid_id=bid.id) }}" class="qna-form">
                    {{ question_form.hidden_tag() }}
                    {{ question_form.question_text(rows=3, placeholder="Ask about vehicle history, specific features, etc.") }}
                    <button type="submit" class="btn approve small">Send</button>
                    <span class="form-feedback"></span>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="offer-footer">
        <span class="valid-until">Offer valid until: {{ bid.valid_until.strftime('%b %d, %Y') }}</span>
        {% if car_request.status == 'active' %}
        <form action="{{ url_for('request.accept_offer', bid_id=bid.id) }}" method="POST" class="accept-offer-form" onsubmit="return confirm('Are you sure you want to accept this offer? This will close the request to other offers.');">
            <div class="accept-options">
                <label class="accept-radio">
                    <input type="radio" name="payment_method" value="cash" checked>
                    Accept Cash Price
                </label>
                {% if bid.price_with_loan %}
                <label class="accept-radio">
                    <input type="radio" name="payment_method" value="loan">
                    Accept Loan Price
                </label>
                {% endif %}
            </div>
            <button type="submit" class="btn approve">Accept This Offer</button>
        </form>
        {% elif bid.status == 'accepted' %}
            <span class="status-approved">Offer Accepted</span>
        {% endif %}
    </div>
</div>
{% endmacro %}


{% macro render_car_card(car) %}
    {% set detail_url = '' %}
    {% if car.listing_type == 'auction' and car.auction %}
        {% set detail_url = url_for('auctions.auction_detail', auction_id=car.auction.id) %}
    {% elif car.listing_type == 'sale' %}
        {% set detail_url = url_for('main.car_detail', car_id=car.id) %}
    {% elif car.listing_type == 'rental' and car.rental_listing %}
        {% set detail_url = url_for('rentals.rental_detail', listing_id=car.rental_listing.id) %}
    {% endif %}

    <a href="{{ detail_url }}" class="auction-card-link">
        <div class="auction-card">
            <div class="card-image-container">
                <img src="{{ car.primary_image_url or url_for('static', filename='img/default_car.png') }}" alt="Image of {{ car.make }} {{ car.model }}">
                {% if car.owner.is_dealer %}<span class="role-badge dealer">Dealer</span>{% elif car.owner.is_admin %}<span class="role-badge admin">Admin</span>{% elif car.owner.is_rental_company %}<span class="role-badge rental">Rental Co.</span>{% endif %}
                <span class="listing-type-tag {{ car.listing_type.lower() }}">{{ car.listing_type|title }}</span>
                {% if car.is_featured %}<span class="featured-tag">Featured</span>{% endif %}
            </div>
            <div class="card-content">
                <h3>{{ car.year }} {{ car.make }} {{ car.model }}</h3>
                <div class="card-details">
                    {% if car.listing_type == 'auction' and car.auction %}
                        <p>{{ '{:,.2f}'.format(car.auction.current_price) }} ETB</p>
                        <span class="bid-count">{{ car.auction.bids.count() }} bids</span>
                    {% elif car.listing_type == 'sale' %}
                        <p>{{ '{:,.2f}'.format(car.fixed_price) }} ETB</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </a>
{% endmacro %}