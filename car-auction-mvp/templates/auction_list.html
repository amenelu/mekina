{% extends "base.html" %}

{% block title %}All Auctions{% endblock %}

{% block content %}
    <h1>All Active Auctions</h1>

    <div class="filter-container">
        <h3>Filter Results</h3>
        <form id="filter-form">
            <input type="text" name="make" placeholder="Make">
            <input type="text" name="model" placeholder="Model">
            <input type="number" name="max_price" placeholder="Max Price">
            <select name="transmission">
                <option value="">Any Transmission</option>
                <option value="Automatic">Automatic</option>
                <option value="Manual">Manual</option>
            </select>
            <select name="drivetrain">
                <option value="">Any Drivetrain</option>
                <option value="FWD">FWD</option>
                <option value="RWD">RWD</option>
                <option value="AWD">AWD</option>
                <option value="4WD">4WD</option>
            </select>
            <input type="number" name="max_mileage" placeholder="Max Mileage">
            <select name="fuel_type">
                <option value="">Any Fuel Type</option>
                <option value="Gasoline">Gasoline</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
            </select>
        </form>
    </div>

    <div id="auction-grid-container" class="auction-grid">
        <!-- Auction cards will be dynamically inserted here -->
    </div>
    <p id="no-results-message" style="display: none;">No auctions match your filter criteria.</p>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filter-form');
    const gridContainer = document.getElementById('auction-grid-container');
    const noResultsMessage = document.getElementById('no-results-message');

    function fetchAuctions() {
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);

        // Remove empty values
        for (let p of params) {
            if (!p[1]) {
                params.delete(p[0]);
            }
        }

        fetch(`{{ url_for('auctions.filter_auctions_api') }}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                gridContainer.innerHTML = ''; // Clear existing results
                if (data.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                    data.forEach(auction => {
                        const cardLink = document.createElement('a');
                        cardLink.href = auction.detail_url;
                        cardLink.className = 'auction-card-link';
                        cardLink.innerHTML = `
                            <div class="auction-card">
                                ${auction.owner_role ? `<span class="role-badge ${auction.owner_role.toLowerCase()}">${auction.owner_role}</span>` : ''}
                                <img src="${auction.image_url}" alt="Car Image">
                                <div class="card-content">
                                    <h3>${auction.year} ${auction.make} ${auction.model}</h3>
                                    <div class="card-details">
                                        <div>
                                            <p>${auction.current_price.toLocaleString('en-US', { style: 'currency', currency: 'ETB', minimumFractionDigits: 2 })}</p>
                                            <span class="bid-count">${auction.bid_count} bids</span>
                                        </div>
                                        <span class="time-left">${auction.time_left}</span>
                                    </div>
                                </div>
                            </div>`;
                        gridContainer.appendChild(cardLink);
                    });
                }
            })
            .catch(error => console.error('Error fetching auctions:', error));
    }

    function applyUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.forEach((value, key) => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) {
                if (input.type === 'radio' || input.type === 'checkbox') {
                    input.checked = true;
                } else {
                    input.value = value;
                }
            }
        });
    }

    // Fetch auctions on initial page load
    applyUrlParams();
    fetchAuctions();

    // Add event listeners to all form inputs to refetch on change
    form.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', fetchAuctions);
    });
});
</script>
{% endblock %}