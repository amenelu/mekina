{% extends "base.html" %}

{% block title %}Rent a Car - Mekina Auction{% endblock %}

{% block page_styles %}
<style>
    /* New styles for the rental filter sidebar */
    .filter-page-container {
        display: flex;
        gap: 30px;
        align-items: flex-start;
    }

    .filter-sidebar {
        flex: 0 0 280px; /* Sidebar width, doesn't grow or shrink */
        position: sticky;
        top: 20px; /* Distance from top when scrolling */
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .filter-results-content {
        flex: 1; /* Takes up the remaining space */
    }
    .filter-sidebar h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.75rem;
        font-size: 1.25rem;
    }
    .filter-group {
        margin-bottom: 1rem;
    }
    .filter-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    .filter-group input[type="search"],
    .filter-group select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ced4da;
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 992px) {
        .filter-page-container {
            flex-direction: column;
        }
        .filter-sidebar {
            position: static; /* Un-stick the sidebar */
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="dashboard-full-width-container">
    <div class="dashboard-header-wrapper">
        <div class="container">
            <div class="dashboard-header">
                <div class="header-main">
                    <h1>Rent a Car</h1>
                    <p>Find the perfect vehicle for your needs from our trusted rental partners.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="filter-page-container">
            <aside class="filter-sidebar">
                <h3>Filters</h3>
                <form id="filter-form">
                    <div class="filter-group">
                        <label for="search-input">Search</label>
                        <input type="search" id="search-input" name="q" placeholder="Make, model, year...">
                    </div>
                    <div class="filter-group">
                        <label for="max-price-filter">Max Price (per day)</label>
                        <select id="max-price-filter" name="max_price">
                            <option value="">Any Price</option>
                            <option value="2000">Under 2,000 ETB</option>
                            <option value="4000">Under 4,000 ETB</option>
                            <option value="6000">Under 6,000 ETB</option>
                            <option value="8000">Under 8,000 ETB</option>
                            <option value="10000">Under 10,000 ETB</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="body-type-filter">Body Type</label>
                        <select id="body-type-filter" name="body_type">
                            <option value="">All Body Types</option>
                            <option value="Sedan">Sedan</option>
                            <option value="SUV">SUV</option>
                            <option value="Hatchback">Hatchback</option>
                            <option value="Minivan">Minivan</option>
                            <option value="Pickup">Pickup</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="transmission-filter">Transmission</label>
                        <select id="transmission-filter" name="transmission">
                            <option value="">Any</option>
                            <option value="Automatic">Automatic</option>
                            <option value="Manual">Manual</option>
                        </select>
                    </div>
                    <button type="button" id="reset-filters" class="btn delete small" style="width: 100%; margin-top: 1rem;">Reset Filters</button>
                </form>
            </aside>
            <main class="filter-results-content">
                <div class="results-wrapper">
                    <div id="rental-grid-container" class="auction-grid">
                        <!-- Rental cars will be loaded here by JavaScript -->
                    </div>
                    <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
                </div>
                <p id="no-results-message" style="display: none;">No rental cars match your filter criteria.</p>
            </main>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filter-form');
    const gridContainer = document.getElementById('rental-grid-container');
    const noResultsMessage = document.getElementById('no-results-message');
    const loadingSpinner = document.getElementById('loading-spinner');
    const resetBtn = document.getElementById('reset-filters');

    const allFilters = form.querySelectorAll('input, select');

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function fetchRentals() {
        loadingSpinner.style.display = 'block';
        gridContainer.style.opacity = '0.5';

        const params = new URLSearchParams(new FormData(form));

        // CRITICAL FIX: Remove empty parameters so the initial fetch works correctly.
        for (const [key, value] of [...params.entries()]) {
            if (!value) {
                params.delete(key);
            }
        }

        fetch(`{{ url_for('rentals.api_filter_rentals') }}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                gridContainer.style.opacity = '1';
                gridContainer.innerHTML = '';
                if (data.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                    data.forEach(listing => {
                        const cardLink = document.createElement('a');
                        cardLink.href = listing.detail_url;
                        cardLink.className = 'auction-card-link';
                        cardLink.innerHTML = `
                            <div class="auction-card">
                                <div class="card-image-container">
                                    <img src="${listing.image_url}" alt="Car Image">
                                    ${listing.is_featured ? `<span class="featured-tag">Featured</span>` : ''}
                                    <span class="listing-type-tag rental">${listing.listing_type}</span>
                                </div>
                                <div class="card-content">
                                    <h3>${listing.year} ${listing.make} ${listing.model}</h3>
                                    <div class="card-details">
                                        <p>${listing.price_display}</p>
                                    </div>
                                </div>
                            </div>`;
                        gridContainer.appendChild(cardLink);
                    });
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                gridContainer.style.opacity = '1';
                console.error('Error fetching rentals:', error);
            });
    }

    const debouncedFetch = debounce(fetchRentals, 300);

    allFilters.forEach(filter => {
        filter.addEventListener('input', debouncedFetch); // 'input' works for both typing and select changes
    });

    resetBtn.addEventListener('click', () => {
        form.reset();
        fetchRentals();
    });

    // Initial load
    fetchRentals();
});
</script>
{% endblock %}