{% extends "base.html" %}

{% block title %}All Listings{% endblock %}

{% block content %}
    <h1>All Listings</h1>
    <p>Browse our full inventory of auctions, rentals, and other vehicles for sale.</p>

    <div class="search-hero" style="padding: 2rem 0; background: none;">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Search by make, model, year...">
            <button id="search-button">Search</button>
        </div>
        <div class="quick-filters">
            <button class="filter-btn" data-filter="condition" data-value="New">New</button>
            <button class="filter-btn" data-filter="condition" data-value="Used">Used</button>
            <button class="filter-btn" data-filter="fuel_type" data-value="Electric">EV</button>
            <button class="filter-btn" data-filter="fuel_type" data-value="Hybrid">Hybrid</button>
            <button class="filter-btn" data-filter="body_type" data-value="SUV">SUV</button>
            <button class="filter-btn" data-filter="body_type" data-value="Sedan">Sedan</button>
            <button class="filter-btn" data-filter="max_price" data-value="5000000">&lt; 5M ETB</button>
        </div>
    </div>

    <div id="listing-grid-container" class="auction-grid">
        <!-- Listings will be dynamically inserted here -->
    </div>
    <p id="no-results-message" style="display: none;">No listings match your filter criteria.</p>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gridContainer = document.getElementById('listing-grid-container');
    const noResultsMessage = document.getElementById('no-results-message');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const filterButtons = document.querySelectorAll('.filter-btn');
    let activeFilters = {};

    function fetchListings() {
        const params = new URLSearchParams();
        // Add text search
        if (searchInput.value) {
            params.append('q', searchInput.value);
        }
        // Add active filters
        for (const [key, value] of Object.entries(activeFilters)) {
            if (value) {
                params.append(key, value);
            }
        }

        fetch(`{{ url_for('auctions.all_listings_api') }}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                gridContainer.innerHTML = ''; // Clear existing results
                if (data.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                    data.forEach(listing => {
                        const cardLink = document.createElement('a');
                        cardLink.href = listing.detail_url || '#';
                        cardLink.className = 'auction-card-link';

                        // Build card details conditionally
                        let detailsHtml = '';
                        if (listing.current_price !== undefined) {
                            detailsHtml = `
                                <div class="card-details">
                                    <div>
                                        <p>${listing.current_price.toLocaleString('en-US', { style: 'currency', currency: 'ETB', minimumFractionDigits: 2 })}</p>
                                        <span class="bid-count">${listing.bid_count} bids</span>
                                    </div>
                                    <span class="time-left">${listing.time_left}</span>
                                </div>`;
                        }

                        cardLink.innerHTML = `
                            <div class="auction-card">
                                ${listing.owner_role ? `<span class="role-badge ${listing.owner_role.toLowerCase()}">${listing.owner_role}</span>` : ''}
                                ${listing.current_price !== undefined ? '<span class="listing-type-tag">Auction</span>' : ''}
                                <img src="${listing.image_url}" alt="Car Image">
                                <div class="card-content">
                                    <h3>${listing.year} ${listing.make} ${listing.model}</h3>
                                    ${detailsHtml}
                                </div>
                            </div>`;
                        gridContainer.appendChild(cardLink);
                    });
                }
            })
            .catch(error => console.error('Error fetching listings:', error));
    }

    searchButton.addEventListener('click', fetchListings);
    searchInput.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            fetchListings();
        }
    });

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.dataset.filter;
            const value = this.dataset.value;

            if (this.classList.contains('active')) {
                this.classList.remove('active');
                delete activeFilters[filter];
            } else {
                document.querySelectorAll(`.filter-btn[data-filter="${filter}"]`).forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                activeFilters[filter] = value;
            }
            fetchListings();
        });
    });

    // Initial load
    fetchListings();
});
</script>
{% endblock %}