{% extends "base.html" %}

{% block title %}All Listings{% endblock %}

{% block content %}
    <h1>All Vehicle Listings</h1>

    <div class="filter-container">
        <h3>Filter Results</h3>
        <form id="filter-form">
            <input type="text" name="q" placeholder="Make, Model, Year...">
            <select name="condition">
                <option value="">Any Condition</option>
                <option value="New">New</option>
                <option value="Used">Used</option>
            </select>
            <select name="body_type">
                <option value="">Any Body Type</option>
                <option value="SUV">SUV</option>
                <option value="Sedan">Sedan</option>
                <option value="Hatchback">Hatchback</option>
                <option value="Pickup">Pickup Truck</option>
            </select>
            <select name="fuel_type">
                <option value="">Any Fuel Type</option>
                <option value="Gasoline">Gasoline</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
                <option value="Hybrid">Hybrid</option>
            </select>
        </form>
    </div>

    <div id="listing-grid-container" class="auction-grid">
        <!-- Listing cards will be dynamically inserted here -->
    </div>
    <p id="no-results-message" style="display: none;">No listings match your filter criteria.</p>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filter-form');
    const gridContainer = document.getElementById('listing-grid-container');
    const noResultsMessage = document.getElementById('no-results-message');

    function fetchListings() {
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);

        // Remove empty values
        for (let p of params) {
            if (!p[1]) {
                params.delete(p[0]);
            }
        }

        fetch(`{{ url_for('auctions.all_listings_api') }}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                gridContainer.innerHTML = ''; // Clear existing results
                if (data.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                    data.forEach(listing => {
                        const cardLink = document.createElement('a');
                        cardLink.href = listing.detail_url;
                        cardLink.className = 'auction-card-link';
                        // This card structure can be enhanced to show different details for different listing types
                        cardLink.innerHTML = `
                            <div class="auction-card">
                                ${listing.is_featured ? `<span class="featured-tag">Featured</span>` : ''}
                                ${listing.owner_role ? `<span class="role-badge ${listing.owner_role.toLowerCase()}">${listing.owner_role}</span>` : ''}
                                <span class="listing-type-tag ${listing.listing_type.toLowerCase().replace(' ', '-')}">${listing.listing_type}</span>
                                <img src="${listing.image_url}" alt="Car Image">
                                <div class="card-content">
                                    <h3>${listing.year} ${listing.make} ${listing.model}</h3>
                                    <div class="card-details">
                                        <p>${listing.price_display}</p>
                                        <span class="time-left">${listing.time_left || ''}</span>
                                    </div>
                                </div>
                            </div>`;
                        gridContainer.appendChild(cardLink);
                    });
                }
            })
            .catch(error => console.error('Error fetching listings:', error));
    }

    // Apply URL parameters from the request flow to the filter form
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.forEach((value, key) => {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) input.value = value;
    });

    fetchListings(); // Initial fetch
    form.querySelectorAll('input, select').forEach(input => input.addEventListener('input', fetchListings));
});
</script>
{% endblock %}