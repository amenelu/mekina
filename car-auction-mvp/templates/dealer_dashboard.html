{% extends "base.html" %}

{% block title %}Dealer Dashboard{% endblock %}

{# This block shows how you would add the notification link to your base template's navigation #}
{% block navigation_items %}
    <a href="{{ url_for('main.notifications') }}">
        Notifications 
        {% if unread_notifications > 0 %}<span class="notification-badge">{{ unread_notifications }}</span>{% endif %}
    </a>
{% endblock %}

{% block content %}
    <h1>Dealer Dashboard</h1>
    <div style="margin-bottom: 20px;">
        <div class="stat-card" style="margin-bottom: 1rem; text-align: right;">
            <strong>Your Points:</strong> {{ current_user.points }}
            {# You can add a link here to a future "buy points" page #}
        </div>
        <a href="{{ url_for('seller.submit_car') }}" class="nav-button" style="background-color: hsl(var(--success)); text-decoration: none;">+ List a New Car</a>
    </div>

    <div class="dashboard-section">
        <h2>Active Customer Requests</h2>
        {% if requests %}
            <p>The following customers are looking for a car. You can view their request and place an offer.</p>
            <table>
                <thead>
                    <tr>
                        <th>Request Date</th>
                        <th>Customer Request</th>
                        <th>Bidders</th>
                        <th>Lowest Offer</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for car_request, bid_count, lowest_offer in requests %}
                    <tr>
                        <td>{{ car_request.created_at.strftime('%b %d, %Y') }}</td>
                        <td>
                            {% if car_request.make and car_request.model %}
                                <strong>{{ car_request.make }} {{ car_request.model }}</strong> ({{ car_request.min_year or 'Any' }}+)
                            {% else %}
                                <em>General Request</em>
                            {% endif %}
                            <blockquote class="compact">{{ car_request.notes|truncate(100) }}</blockquote>
                        </td>
                        <td>
                            {% if bid_count and bid_count > 0 %}
                                {{ bid_count }} dealer(s)
                            {% else %}
                                <span class="text-muted">None yet</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if lowest_offer %}
                                {{ '{:,.2f}'.format(lowest_offer) }} ETB
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('dealer.place_bid', request_id=car_request.id) }}" class="btn">Place Offer</a>
                        </td>
                    </>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>There are no active customer requests at the moment.</p>
        {% endif %}
    </div>

    <hr>

    <h2>My Listings</h2>
    {% if my_cars %}
        <table>
            <thead>
                <tr>
                    <th>Car</th>
                    <th>Status</th>
                    <th>Auction Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for car in my_cars %}
                <tr>
                    <td>{{ car.year }} {{ car.make }} {{ car.model }}</td>
                    <td>
                        {% if car.is_approved %}
                            <span style="color: hsl(var(--success)); font-weight: bold;">Approved</span>
                        {% else %}
                            <span style="color: hsl(var(--warning)); font-weight: bold;">Pending Approval</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if car.auction and car.auction.end_time > now %}
                            Active (Ends: {{ car.auction.end_time.strftime('%Y-%m-%d %H:%M') }})
                        {% elif car.listing_type == 'auction' and car.auction and car.auction.end_time <= now %}
                            Expired
                        {% elif car.listing_type == 'sale' or car.listing_type == 'rental' %}
                            Live
                        {% else %}
                            No Auction Yet
                        {% endif %}
                    </td>
                    <td>
                        {% if not car.is_approved %}<a href="{{ url_for('seller.edit_car', car_id=car.id) }}">Edit</a>{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>You have not submitted any cars yet.</p>
    {% endif %}

    <hr>

    <h2>My Unanswered Questions</h2>
    {% if unanswered_questions %}
        <table>
             <thead>
                <tr>
                    <th>Car</th>
                    <th>Question</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for q in unanswered_questions %}
                <tr>
                    <td>{{ q.auction.car.year }} {{ q.auction.car.make }} {{ q.auction.car.model }}</td>
                    <td>{{ q.question_text }}</td>
                    <td><a href="{{ url_for('seller.answer_question', question_id=q.id) }}">Answer</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>You have no unanswered questions.</p>
    {% endif %}

    <hr>

    <h2>Unanswered Questions on Your Offers</h2>
    {% if unanswered_request_questions %}
        <table>
             <thead>
                <tr>
                    <th>Customer Request</th>
                    <th>Question</th>
                    <th>Your Offer</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for q in unanswered_request_questions %}
                <tr>
                    <td>
                        <a href="{{ url_for('dealer.place_bid', request_id=q.dealer_bid.request_id) }}"><strong>Request #{{ q.dealer_bid.request_id }}</strong></a>
                        {% if q.dealer_bid.car_request.make and q.dealer_bid.car_request.model %}
                            <p>{{ q.dealer_bid.car_request.make }} {{ q.dealer_bid.car_request.model }}</p>
                        {% else %}
                            <p class="text-muted">{{ q.dealer_bid.car_request.notes|truncate(50) }}</p>
                        {% endif %}
                    </td>
                    <td>{{ q.question_text }}</td>
                    <td><strong>{{ '{:,.2f}'.format(q.dealer_bid.price) }} ETB</strong></td>
                    <td><a href="{{ url_for('dealer.answer_request_question', question_id=q.id) }}">Answer</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>You have no unanswered questions on your offers.</p>
    {% endif %}
{% endblock %}