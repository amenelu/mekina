{% extends "base.html" %}

{% macro display_request_notes(notes) %}
    {% set lines = notes.split('\n') %}
    <ul class="request-notes-list">
    {% for line in lines %}
        {% if line.strip() and ':' in line %}
            {% set parts = line.split(':', 1) %}
            <li>
                <strong>{{ parts[0].replace('-', '').strip() }}:</strong>
                <span>{{ parts[1].strip() }}</span>
            </li>
        {% elif line.strip() %}
            <li>{{ line.strip() }}</li>
        {% endif %}
    {% endfor %}
    </ul>
{% endmacro %}

{% block title %}Dealer Dashboard{% endblock %}

{# This block shows how you would add the notification link to your base template's navigation #}
{% block navigation_items %}
    <a href="{{ url_for('main.notifications') }}">
        Notifications 
        {% if unread_notifications > 0 %}<span class="notification-badge">{{ unread_notifications }}</span>{% endif %}
    </a>
{% endblock %}

{% block content %}
    <h1>Dealer Dashboard</h1>
    <div style="margin-bottom: 20px;">
        <div class="stat-card" style="margin-bottom: 1rem; text-align: right;">
            <strong>Your Points:</strong> {{ current_user.points }}
            {# You can add a link here to a future "buy points" page #}
        </div>
        <a href="{{ url_for('seller.submit_car') }}" class="nav-button" style="background-color: hsl(var(--success)); text-decoration: none;">+ List a New Car</a>
    </div>

    <div class="dashboard-section">
        <h2>Active Customer Requests</h2>
        {% if requests %}
            <p>The following customers are looking for a car. You can view their request and place an offer.</p>
            <div class="table-responsive-wrapper">
                <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Request Date</th>
                        <th>Customer Request</th>
                        <th>Bidders</th>
                        <th>Lowest Offer</th>
                        <th class="actions-column"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for car_request, bid_count, lowest_offer in requests %}
                    <tr class="clickable-row" data-href="{{ url_for('dealer.place_bid', request_id=car_request.id) }}">
                        <td>{{ car_request.created_at.strftime('%b %d, %Y') }}</td>
                        <td>
                            {% if car_request.make and car_request.model %}
                                <strong>{{ car_request.make }} {{ car_request.model }}</strong> ({{ car_request.min_year or 'Any' }}+)
                            {% else %}
                                <em>General Request</em>
                            {% endif %}
                            {% if car_request.make and car_request.model %}
                                <blockquote class="compact">{{ car_request.notes|truncate(100) }}</blockquote>
                            {% else %}
                                {# This is a "help me decide" request, so format the notes #}
                                {{ display_request_notes(car_request.notes) }}
                            {% endif %}
                        </td>
                        <td>
                            {% if bid_count and bid_count > 0 %}
                                {{ bid_count }} dealer(s)
                            {% else %}
                                <span class="text-muted">None yet</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if lowest_offer %}
                                {{ '{:,.2f}'.format(lowest_offer) }} ETB
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="actions-column">
                            <a href="{{ url_for('dealer.place_bid', request_id=car_request.id) }}" class="btn">Place Offer</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        {% else %}
            <p>There are no active customer requests at the moment.</p>
        {% endif %}
    </div>

    <hr>
    <div class="dashboard-section">
        <h2>My Listings</h2>
        {% if my_cars %}
            <div class="table-responsive-wrapper">
                <table class="dashboard-table">
            <thead>
                <tr>
                    <th>Car</th>
                    <th>Status</th>
                    <th>Visibility</th>
                    <th>Auction Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for car in my_cars %}
                <tr>
                    <td>{{ car.year }} {{ car.make }} {{ car.model }}</td>
                    <td>
                        {% if car.is_approved %}
                            <span style="color: hsl(var(--success)); font-weight: bold;">Approved</span>
                        {% else %}
                            <span style="color: hsl(var(--warning)); font-weight: bold;">Pending Approval</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if car.is_approved %}
                        <label class="switch">
                            <input type="checkbox" class="visibility-toggle" data-car-id="{{ car.id }}" {% if car.is_active %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                        <span id="status-text-{{ car.id }}" class="availability-text">{% if car.is_active %}Active{% else %}Inactive{% endif %}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if car.auction and car.auction.end_time > now %}
                            Active (Ends: {{ car.auction.end_time.strftime('%Y-%m-%d %H:%M') }})
                        {% elif car.listing_type == 'auction' and car.auction and car.auction.end_time <= now %}
                            Expired
                        {% elif car.listing_type == 'sale' or car.listing_type == 'rental' %}
                            Live
                        {% else %}
                            No Auction Yet
                        {% endif %}
                    </td>
                    <td>
                        <div class="button-group">
                            {% if not car.is_approved %}<a href="{{ url_for('seller.edit_car', car_id=car.id) }}" class="btn edit small">Edit</a>{% endif %}
                            <form action="{{ url_for('seller.delete_car', car_id=car.id) }}" method="post" onsubmit="return confirm('Are you sure you want to permanently delete this listing?');">
                                <button type="submit" class="btn delete small">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
            </div>
        {% else %}
            <p>You have not submitted any cars yet.</p>
        {% endif %}
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle the visibility toggle
    document.querySelectorAll('.visibility-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const carId = this.dataset.carId;
            const statusText = document.getElementById(`status-text-${carId}`);

            fetch(`/seller/toggle_active/${carId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusText.textContent = data.status_text;
                } else {
                    this.checked = !this.checked; // Revert toggle on error
                    alert(data.message || 'An error occurred.');
                }
            });
        });
    });

    // Make table rows clickable
    document.querySelectorAll('tr.clickable-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if a button or link inside the row was clicked (for desktop)
            if (e.target.closest('a, button')) return;
            window.location.href = this.dataset.href;
        });
    });
});
</script>

    <hr>
    <div class="dashboard-section">
        <h2>My Unanswered Questions</h2>
        {% if unanswered_questions %}
            <div class="table-responsive-wrapper">
                <table class="dashboard-table">
             <thead>
                <tr>
                    <th>Car</th>
                    <th>Question</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for q in unanswered_questions %}
                <tr>
                    <td>{{ q.auction.car.year }} {{ q.auction.car.make }} {{ q.auction.car.model }}</td>
                    <td>{{ q.question_text }}</td>
                    <td><a href="{{ url_for('seller.answer_question', question_id=q.id) }}">Answer</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
            </div>
        {% else %}
            <p>You have no unanswered questions.</p>
        {% endif %}
    </div>

    <hr>
    <div class="dashboard-section">
        <h2>Unanswered Questions on Your Offers</h2>
        {% if unanswered_request_questions %}
            <div class="table-responsive-wrapper">
                <table class="dashboard-table">
             <thead>
                <tr>
                    <th>Customer Request</th>
                    <th>Question</th>
                    <th>Your Offer</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for q in unanswered_request_questions %}
                <tr>
                    <td>
                        <a href="{{ url_for('dealer.place_bid', request_id=q.dealer_bid.request_id) }}"><strong>Request #{{ q.dealer_bid.request_id }}</strong></a>
                        {% if q.dealer_bid.car_request.make and q.dealer_bid.car_request.model %}
                            <p>{{ q.dealer_bid.car_request.make }} {{ q.dealer_bid.car_request.model }}</p>
                        {% else %}
                            <p class="text-muted">{{ q.dealer_bid.car_request.notes|truncate(50) }}</p>
                        {% endif %}
                    </td>
                    <td>{{ q.question_text }}</td>
                    <td><strong>{{ '{:,.2f}'.format(q.dealer_bid.price) }} ETB</strong></td>
                    <td><a href="{{ url_for('dealer.answer_request_question', question_id=q.id) }}">Answer</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
            </div>
        {% else %}
            <p>You have no unanswered questions on your offers.</p>
        {% endif %}
    </div>
{% endblock %}