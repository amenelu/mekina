{% extends "base.html" %}

{% block title %}Offers for Your Request{% endblock %}
{% from "_macros.html" import offer_card %}
{% block content %}
    <h1>Offers for Your Request</h1>

    <div class="question-context">
        <h3>Your Request Details</h3>
        {% if car_request.make %}
            <p><strong>Make:</strong> {{ car_request.make }}</p>
            <p><strong>Model:</strong> {{ car_request.model or 'Any' }}</p>
            <p><strong>Minimum Year:</strong> {{ car_request.min_year or 'Any' }}</p>
        {% endif %}
        <p><strong>Notes:</strong> {{ car_request.notes or 'None' }}</p>
        {% if car_request.status != 'active' and car_request.accepted_bid %}
            <div class="status-closed" style="margin-top: 1rem; padding: 1rem; background-color: hsl(var(--success)/0.1); border: 1px solid hsl(var(--success)); border-radius: var(--radius);">
                This request is now closed. <a href="{{ url_for('request.deal_summary', deal_id=car_request.accepted_bid.deal.id) }}">View the final deal.</a>
            </div>
        {% endif %}
    </div>

    <h2>Dealer Offers</h2>
    {% if bids %}
        <p>You have received {{ bids|length }} offer(s). The lowest offer is highlighted.</p>
        
        <div class="offer-table-wrapper">
            {% for bid in bids %}
                {{ offer_card(bid, car_request, question_form, is_lowest=loop.first) }}
            {% endfor %}
        </div>
    {% else %}
        <p>No dealers have placed an offer on your request yet. Please check back soon!</p>
    {% endif %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle visibility of "ask question" forms
        document.querySelectorAll('.ask-question-btn').forEach(button => {
            button.addEventListener('click', function() {
                const bidId = this.dataset.bidId;
                const formDiv = document.getElementById(`ask-form-${bidId}`);
                formDiv.style.display = formDiv.style.display === 'none' ? 'block' : 'none';
            });
        });
    
        // Handle AJAX form submission for questions
        document.querySelectorAll('.qna-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const feedbackSpan = this.querySelector('.form-feedback');
    
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        feedbackSpan.textContent = data.message;
                        feedbackSpan.style.color = 'hsl(var(--success))';
                        this.reset();
                        // Hide the form and reload to show the new question
                        setTimeout(() => {
                            this.parentElement.style.display = 'none';
                            feedbackSpan.textContent = '';
                            location.reload();
                        }, 2000);
                    } else {
                        // Display errors
                        let errorMsg = 'An error occurred.';
                        if (data.errors && data.errors.question_text) {
                            errorMsg = data.errors.question_text[0];
                        }
                        feedbackSpan.textContent = errorMsg;
                        feedbackSpan.style.color = 'hsl(var(--danger))';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    feedbackSpan.textContent = 'A network error occurred.';
                    feedbackSpan.style.color = 'hsl(var(--danger))';
                });
            });
        });
    });
    </script>
{% endblock %}