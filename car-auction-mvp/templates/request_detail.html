{% extends "base.html" %}

{% block title %}Offers for Your Request{% endblock %}

{% macro offer_card(bid, loop_index, is_lowest=false) %}
<div class="offer-card {% if is_lowest %}lowest-bid-highlight{% endif %}">
    <div class="offer-header">
        <div class="offer-price">
            {{ '{:,.2f}'.format(bid.price) }} ETB
        </div>
        <div class="offer-meta">
            <span>From: <strong>Dealer #{{ loop_index }}</strong></span>
            <span>Received: {{ bid.timestamp.strftime('%b %d, %Y') }}</span>
        </div>
    </div>
    <div class="offer-details-grid">
        <div><strong>Year:</strong> {{ bid.car_year }}</div>
        <div><strong>Condition:</strong> {{ bid.condition }}</div>
        <div><strong>Mileage:</strong> {{ '{:,}'.format(bid.mileage) }} km</div>
        <div><strong>Availability:</strong> {{ bid.availability }}</div>
    </div>
    {% if bid.extras %}
    <div class="offer-extras">
        <strong>Extras:</strong> {{ bid.extras }}
    </div>
    {% endif %}
    {% if bid.message %}
    <div class="offer-message">
        <strong>Message from Dealer:</strong>
        <blockquote>{{ bid.message }}</blockquote>
    </div>
    {% endif %}
    <div class="offer-footer">
        <span class="valid-until">Offer valid until: {{ bid.valid_until.strftime('%b %d, %Y') }}</span>
        {% if car_request.status == 'active' %}
        <form action="{{ url_for('request.accept_offer', bid_id=bid.id) }}" method="POST" style="display: inline;">
            <button type="submit" class="btn approve" onclick="return confirm('Are you sure you want to accept this offer? This will close the request to other offers.');">Accept Offer</button>
        </form>
        {% elif bid.status == 'accepted' %}
            <span class="status-approved">Offer Accepted</span>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% block content %}
    <h1>Offers for Your Request</h1>

    <div class="question-context">
        <h3>Your Request Details</h3>
        {% if car_request.make %}
            <p><strong>Make:</strong> {{ car_request.make }}</p>
            <p><strong>Model:</strong> {{ car_request.model or 'Any' }}</p>
            <p><strong>Minimum Year:</strong> {{ car_request.min_year or 'Any' }}</p>
        {% endif %}
        <p><strong>Notes:</strong> {{ car_request.notes or 'None' }}</p>
        {% if car_request.status != 'active' and car_request.accepted_bid %}
            <div class="status-closed" style="margin-top: 1rem; padding: 1rem; background-color: hsl(var(--success)/0.1); border: 1px solid hsl(var(--success)); border-radius: var(--radius);">
                This request is now closed. <a href="{{ url_for('request.deal_summary', deal_id=car_request.accepted_bid.deal.id) }}">View the final deal.</a>
            </div>
        {% endif %}
    </div>

    <h2>Dealer Offers</h2>
    {% if bids %}
        <p>You have received {{ bids|length }} offer(s). The lowest offer is highlighted.</p>
        
        <div class="offer-list">
            {% for bid in bids %}
                {{ offer_card(bid, loop.index, is_lowest=loop.first) }}
            {% endfor %}
        </div>
    {% else %}
        <p>No dealers have placed an offer on your request yet. Please check back soon!</p>
    {% endif %}
{% endblock %}