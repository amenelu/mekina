{% extends "base.html" %}

{% block title %}Conversation with {{ conversation.buyer.username }}{% endblock %}

{% block main_content %}
<div class="dashboard-full-width-container">
    <div class="dashboard-header-wrapper">
        <div class="container">
            <div class="dashboard-header">
                <div class="header-main">
                    <h1>Conversation with {{ conversation.buyer.username }}</h1>
                    <p>Regarding your listing: <a href="{{ url_for('main.car_detail', car_id=conversation.car.id) }}">{{ conversation.car.year }} {{ conversation.car.make }} {{ conversation.car.model }}</a></p>
                </div>
                <div class="header-actions">
                    <a href="{{ url_for('dealer.list_messages') }}" class="btn">&larr; Back to All Messages</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="chat-container">
            <div class="chat-history" id="chat-history">
                {% for message in conversation.messages.order_by('timestamp') %}
                    {% if message.sender_id == current_user.id %}
                        <div class="chat-message-wrapper sent-wrapper">
                            <div class="chat-message sent">
                                <p>{{ message.body }}</p>
                                <small>{{ message.timestamp.strftime('%b %d, %H:%M') }}</small>
                            </div>
                        </div>
                    {% else %}
                        <div class="chat-message-wrapper received-wrapper">
                            <div class="chat-message received">
                                <p>{{ message.body }}</p>
                                <small>{{ message.timestamp.strftime('%b %d, %H:%M') }}</small>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <p class="system-message">This is the beginning of your conversation.</p>
                {% endfor %}
            </div>
            <div class="chat-input-area">
                <form id="chat-form" data-car-id="{{ conversation.car.id }}">
                    <textarea name="message" id="chat-message-input" placeholder="Type your reply..." required></textarea>
                    <button type="submit" class="btn">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block after_content %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const currentUserId = "{{ current_user.id }}";
    const chatHistory = document.getElementById('chat-history');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('chat-message-input');

    // Scroll to the bottom on initial load
    chatHistory.scrollTop = chatHistory.scrollHeight;

    // Join the conversation room
    socket.emit('join_conversation', { 'conversation_id': "{{ conversation.id }}" });

    // --- Chat Message Sending Logic ---
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            const carId = this.dataset.carId;

            fetch("{{ url_for('main.send_chat_message') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ car_id: carId, message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    messageInput.value = ''; // Clear input
                } else {
                    alert(data.message || 'Failed to send message.');
                }
            }).catch(err => console.error('Chat send error:', err));
        });
    }

    function appendMessage(data) {
        const isSentByMe = data.sender_id == currentUserId;
        const wrapperClass = isSentByMe ? 'sent-wrapper' : 'received-wrapper';
        const messageClass = isSentByMe ? 'sent' : 'received';

        const messageHTML = `
            <div class="chat-message-wrapper ${wrapperClass}">
                <div class="chat-message ${messageClass}">
                    <p>${data.body}</p>
                    <small>${new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                </div>
            </div>`;
        chatHistory.insertAdjacentHTML('beforeend', messageHTML);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    socket.on('new_chat_message', function(data) {
        appendMessage(data);
    });
});
</script>
{% endblock %}