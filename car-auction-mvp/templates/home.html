{% extends "base.html" %}

{% block title %}Welcome - Mekina Auction{% endblock %}

{% block after_content %} {# Use this block to go full-width #}
    <div class="search-hero">
        <div class="container">
            <h1>Find Your Next Car</h1>
            <p>Search Ethiopia's best selection of enthusiast cars for sale.</p>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Start typing to search by make, model, year...">
            </div>
            <div class="quick-filters">
                <button class="filter-btn" data-filter="condition" data-value="New">New</button>
                <button class="filter-btn" data-filter="condition" data-value="Used">Used</button>
                <button class="filter-btn" data-filter="fuel_type" data-value="Electric">EV</button>
                <button class="filter-btn" data-filter="fuel_type" data-value="Hybrid">Hybrid</button>
                <button class="filter-btn" data-filter="body_type" data-value="SUV">SUV</button>
                <button class="filter-btn" data-filter="body_type" data-value="Sedan">Sedan</button>
                <button class="filter-btn" data-filter="max_price" data-value="5000000">&lt; 5M ETB</button>
            </div>
            <div class="find-car-link">
                <span>Can't find what you're looking for?</span>
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('request.start_request') }}">Let us find it for you &rarr;</a>
                {% else %}
                    <a href="{{ url_for('auth.login', next=url_for('request.start_request')) }}">Let us find it for you &rarr;</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Live Auctions Section -->
    <section id="auctions" class="section section-light">
        <div class="container">
            <div class="section-header">
                <h2>All Vehicles for Sale</h2>
                <p>
                    Browse all active auctions and listings.
                </p>
            </div>
            <div id="auction-grid-container" class="auction-grid"></div>
            <p id="no-results-message" style="display: none;">No auctions match your filter criteria.</p>
            <div class="view-all-container">
                <a href="{{ url_for('main.all_listings') }}" class="btn approve">View All Listings</a>
            </div>
        </div>
    </section>

    <!-- Trust Section -->
    <section class="section trust-section">
        <div class="container">
            <div class="section-header">
                <h2>Built on Trust & Transparency</h2>
            </div>
            <div class="trust-grid">
                <div class="stat">
                    <div class="value">100%</div>
                    <div class="label">Admin Reviewed Listings</div>
                </div>
                <div class="stat">
                    <div class="value">Direct</div>
                    <div class="label">Seller Communication</div>
                </div>
                <div class="stat">
                    <div class="value">Verified</div>
                    <div class="label">User Accounts</div>
                </div>
            </div>
        </div>
    </section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gridContainer = document.getElementById('auction-grid-container');
    const noResultsMessage = document.getElementById('no-results-message');
    const searchInput = document.getElementById('search-input');
    const filterButtons = document.querySelectorAll('.filter-btn');
    let activeFilters = {};

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function fetchAuctions() {
        const params = new URLSearchParams();
        // Add text search
        if (searchInput.value) {
            params.append('q', searchInput.value);
        }
        // Add active filters
        for (const [key, value] of Object.entries(activeFilters)) {
            if (value) {
                params.append(key, value);
            }
        }

        // For the homepage, we only want 8 random cars if no filters are active
        if (Object.keys(activeFilters).length === 0 && !searchInput.value) {
            params.append('limit', '6');
            params.append('random', 'true');
        }

        fetch(`{{ url_for('auctions.all_listings_api') }}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                gridContainer.innerHTML = ''; // Clear existing results
                if (data.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                    data.forEach(listing => {
                        const cardLink = document.createElement('a');
                        cardLink.href = listing.detail_url;
                        cardLink.className = 'auction-card-link';
                        cardLink.innerHTML = `
                            <div class="auction-card">
                                ${listing.owner_role ? `<span class="role-badge ${listing.owner_role.toLowerCase()}">${listing.owner_role}</span>` : ''}
                                <span class="listing-type-tag ${listing.listing_type.toLowerCase().replace(' ', '-')}">${listing.listing_type}</span>
                                <img src="${listing.image_url}" alt="Car Image">
                                <div class="card-content">
                                    <h3>${listing.year} ${listing.make} ${listing.model}</h3>
                                    <div class="card-details">
                                        <p>${listing.price_display}</p>
                                        <span class="time-left">${listing.time_left || ''}</span>
                                    </div>
                                </div>
                            </div>`;
                        gridContainer.appendChild(cardLink);
                    });
                }
            })
            .catch(error => console.error('Error fetching auctions:', error));
    }

    const debouncedFetch = debounce(fetchAuctions, 300); // 300ms delay
    searchInput.addEventListener('input', debouncedFetch);
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.dataset.filter;
            const value = this.dataset.value;

            // Toggle active state
            if (this.classList.contains('active')) {
                this.classList.remove('active');
                delete activeFilters[filter];
            } else {
                // Deactivate other buttons for the same filter group
                document.querySelectorAll(`.filter-btn[data-filter="${filter}"]`).forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                activeFilters[filter] = value;
            }
            fetchAuctions();
        });
    });

    // Initial load
    fetchAuctions();
});
</script>
{% endblock %}
