{% extends "base.html" %}
{% from "_macros.html" import render_car_card %}

{% block title %}{{ dealer.username }}'s Profile{% endblock %}

{% block body_class %}dealer-profile-page{% endblock %}

{% block content %}
    {% if current_user.is_admin %}
    <div class="admin-actions">
        <h3>Admin Controls</h3>
        <div class="button-group">
            <a href="{{ url_for('admin.edit_user', user_id=dealer.id) }}" class="btn edit">Edit User Roles</a>
            <form action="{{ url_for('dealer.toggle_verification', dealer_id=dealer.id) }}" method="POST" style="display: inline;">
                <button type="submit" class="btn approve">
                    {% if dealer.is_verified %}Un-verify Dealer{% else %}Verify Dealer{% endif %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="dealer-profile-hero">
        <div class="dealer-info">
            <div class="dealer-logo-placeholder">
                {{ dealer.username[0]|upper }}
            </div>
            <div class="dealer-details">
                <div class="dealer-name-verified">
                    <h1>{{ dealer.username }}</h1>
                    {% if dealer.is_verified %}
                        <span class="verified-badge">Verified</span>
                    {% endif %}
                </div>
                <p class="dealer-tagline">{{ dealer.tagline or 'Trusted seller on Mekina Auction.' }}</p>
                {% if ratings %}
                <div class="dealer-rating-summary">
                    {% for i in range(5) %}
                        <span class="star {% if i < avg_rating %}filled{% endif %}">&#9733;</span>
                    {% endfor %}
                    <span class="rating-text">{{ "%.1f"|format(avg_rating) }} average from {{ ratings|length }} review(s)</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="detail-page-container" style="margin-top: 2rem;">
        <div class="main-content">
            <h2>Active Listings from {{ dealer.username }}</h2>
            {% if listings %}
                <div class="auction-grid">
                    {% for car in listings %}
                        {{ render_car_card(car) }}
                    {% endfor %}
                </div>
            {% else %}
                <p>{{ dealer.username }} has no active listings at the moment.</p>
            {% endif %}
        </div>

        <div class="sidebar">
            <div class="sidebar-section">
                <h3>Customer Reviews</h3>
                {% if ratings %}
                    <div class="review-list">
                        {% for rating in ratings %}
                            <div class="review-card">
                                <div class="review-header">
                                    <div class="star-rating">
                                        {% for i in range(5) %}
                                            <span class="star {% if i < rating.rating %}filled{% endif %}">&#9733;</span>
                                        {% endfor %}
                                    </div>
                                    <strong>{{ rating.buyer.username }}</strong>
                                </div>
                                {% if rating.review_text %}
                                    <p class="review-text">"{{ rating.review_text }}"</p>
                                {% endif %}
                                <small class="text-muted">Reviewed on: {{ rating.timestamp.strftime('%b %d, %Y') }}</small>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>This dealer has not received any reviews yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}